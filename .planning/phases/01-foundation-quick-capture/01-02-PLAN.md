---
phase: 01-foundation-quick-capture
plan: 02
type: execute
wave: 2
depends_on: [01-01]
files_modified:
  - app/src/main/java/com/routinetool/domain/model/Task.kt
  - app/src/main/java/com/routinetool/ui/screens/tasklist/TaskListViewModel.kt
  - app/src/main/java/com/routinetool/ui/screens/tasklist/TaskListScreen.kt
  - app/src/main/java/com/routinetool/ui/components/TaskCard.kt
  - app/src/main/java/com/routinetool/ui/components/DeadlineBadge.kt
  - app/src/main/java/com/routinetool/di/AppModule.kt
autonomous: true

must_haves:
  truths:
    - "User sees a calm, minimal task list with clean visual hierarchy"
    - "User can tap a task card to expand it and see full details"
    - "User can complete a task and feel haptic confirmation"
    - "Completed tasks appear in a Done section at the bottom"
    - "Overdue tasks appear in an Overdue section above the main list"
    - "Empty state shows calm message when no tasks exist"
  artifacts:
    - path: "app/src/main/java/com/routinetool/domain/model/Task.kt"
      provides: "Domain model separate from Room entity"
      contains: "data class Task"
    - path: "app/src/main/java/com/routinetool/ui/screens/tasklist/TaskListViewModel.kt"
      provides: "UDF state management for task list"
      contains: "class TaskListViewModel"
    - path: "app/src/main/java/com/routinetool/ui/screens/tasklist/TaskListScreen.kt"
      provides: "Main task list screen composable"
      contains: "fun TaskListScreen"
    - path: "app/src/main/java/com/routinetool/ui/components/TaskCard.kt"
      provides: "Expandable task card composable"
      contains: "fun TaskCard"
  key_links:
    - from: "TaskListViewModel"
      to: "TaskRepository"
      via: "constructor injection"
      pattern: "class TaskListViewModel.*TaskRepository"
    - from: "TaskListScreen"
      to: "TaskListViewModel"
      via: "koinViewModel()"
      pattern: "koinViewModel"
    - from: "TaskCard"
      to: "animateContentSize"
      via: "Modifier extension"
      pattern: "animateContentSize"
---

<objective>
Build the main task list screen with expandable card UI, sectioned layout (overdue / active / done), empty state, and task completion with haptic feedback.

Purpose: This is the primary screen users see. It must feel calm, minimal, and tool-like — never overwhelming or judgmental. The expandable card pattern is the central interaction model for the entire app.
Output: A fully functional task list screen that displays tasks in ordered sections, supports expand/collapse, and allows task completion.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-quick-capture/01-CONTEXT.md
@.planning/phases/01-foundation-quick-capture/01-RESEARCH.md
@.planning/phases/01-foundation-quick-capture/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Domain model and TaskListViewModel</name>
  <files>
    app/src/main/java/com/routinetool/domain/model/Task.kt
    app/src/main/java/com/routinetool/ui/screens/tasklist/TaskListViewModel.kt
    app/src/main/java/com/routinetool/di/AppModule.kt
  </files>
  <action>
    **Task.kt (domain model):**
    Create a domain model separate from the Room entity:
    ```kotlin
    data class Task(
        val id: String,
        val title: String,
        val description: String?,
        val softDeadline: Instant?,
        val hardDeadline: Instant?,
        val isCompleted: Boolean,
        val completedAt: Instant?,
        val createdAt: Instant,
        val taskType: String
    )
    ```
    Add extension functions in TaskRepository (or a mapper) to convert between TaskEntity (epoch millis) and Task (kotlinx-datetime Instant).

    **TaskListViewModel.kt:**
    Implement UDF pattern with a single StateFlow:
    ```kotlin
    data class TaskListUiState(
        val overdueTasks: List<Task> = emptyList(),
        val activeTasks: List<Task> = emptyList(),
        val doneTasks: List<Task> = emptyList(),
        val expandedTaskId: String? = null,
        val isLoading: Boolean = true
    )
    ```

    ViewModel responsibilities:
    - Combine `observeActiveTasks(now)` and `observeRecentlyCompleted(since24hAgo)` flows into a single UI state
    - Split active tasks into "overdue" (deadline passed) and "active" (deadline in future or no deadline) sections
    - `toggleExpanded(taskId: String)` — expand/collapse card (only one expanded at a time)
    - `completeTask(taskId: String)` — mark task as completed with current timestamp
    - `uncompleteTask(taskId: String)` — undo completion
    - `dismissOverdue(taskId: String)` — remove deadlines from an overdue task (sets both deadlines to null)
    - Use `stateIn(viewModelScope, SharingStarted.WhileSubscribed(5000), initial)` for the combined flow

    Overdue threshold for gentle reschedule suggestion: 7 days (store as constant `LONG_OVERDUE_DAYS = 7`).

    **AppModule.kt:**
    Add `viewModel { TaskListViewModel(get()) }` to the Koin module.
  </action>
  <verify>
    `./gradlew assembleDebug` compiles. ViewModel can be instantiated by Koin (verified during integration in Task 2).
  </verify>
  <done>
    Domain model converts cleanly from Room entity. ViewModel exposes sectioned task state via single StateFlow. All task actions (complete, uncomplete, expand, dismiss overdue) are implemented.
  </done>
</task>

<task type="auto">
  <name>Task 2: TaskListScreen, TaskCard, and supporting composables</name>
  <files>
    app/src/main/java/com/routinetool/ui/screens/tasklist/TaskListScreen.kt
    app/src/main/java/com/routinetool/ui/components/TaskCard.kt
    app/src/main/java/com/routinetool/ui/components/DeadlineBadge.kt
    app/src/main/java/com/routinetool/MainActivity.kt
  </files>
  <action>
    **TaskListScreen.kt:**
    ```kotlin
    @Composable
    fun TaskListScreen(
        onAddTask: () -> Unit,  // FAB callback, wired in Plan 03
        viewModel: TaskListViewModel = koinViewModel()
    )
    ```

    Layout structure using Scaffold:
    - **TopAppBar:** Simple title "Routine Tool" (or just the app name), clean and minimal
    - **FAB:** FloatingActionButton with Icons.Filled.Add, calls `onAddTask`
    - **Content:** LazyColumn with proper Scaffold contentPadding
      - If all sections empty → show EmptyState composable
      - Otherwise render sections in order:
        1. **"Overdue" section** (only if overdueTasks is non-empty): Section header text "Overdue" in muted surfaceVariant color (NOT red, NOT alarming). List overdue TaskCards.
        2. **Active tasks section** (no header needed — this is the default). List active TaskCards.
        3. **"Done" section** (only if doneTasks is non-empty): Section header "Done" in muted color. List done TaskCards with reduced opacity or surfaceVariant background.
    - Use `items(tasks, key = { it.id })` for stable keys
    - `verticalArrangement = Arrangement.spacedBy(8.dp)`
    - `contentPadding = PaddingValues(horizontal = 16.dp, vertical = 8.dp)` merged with scaffold padding

    **EmptyState:** Centered text "Nothing here yet" using `bodyLarge` typography in `onSurfaceVariant` color. No icons, no illustrations, no call-to-action beyond the FAB.

    **TaskCard.kt:**
    Expandable card using `animateContentSize()`:
    ```kotlin
    @Composable
    fun TaskCard(
        task: Task,
        isExpanded: Boolean,
        onExpandToggle: () -> Unit,
        onComplete: () -> Unit,
        onUncomplete: () -> Unit,
        onDismissOverdue: () -> Unit,
        isOverdue: Boolean,
        isLongOverdue: Boolean,  // 7+ days overdue
        modifier: Modifier = Modifier
    )
    ```

    **Collapsed state** (always visible):
    - Checkbox on the left (for completion toggle)
    - Task title (bodyLarge, single line with ellipsis)
    - DeadlineBadge on the right if deadline exists

    **Expanded state** (shown when isExpanded = true):
    - Description text if present (bodyMedium, onSurfaceVariant)
    - Deadline info: soft deadline with Schedule icon, hard deadline with Flag icon
    - If isLongOverdue: gentle text "This has been waiting a while. Reschedule?" with a "Remove deadline" text button — neutral tone, no judgment
    - If isOverdue but not long: just the "X days ago" badge, no nagging
    - "Remove deadline" action (calls onDismissOverdue) — for rescheduling, users edit inline (Phase 3 will add proper editing)

    **Completion interaction:**
    - Tapping checkbox triggers haptic feedback using `LocalView.current.performHapticFeedback(HapticFeedbackConstants.CONFIRM)`
    - Checkbox uses custom colors: checkedColor = primary, uncheckedColor = onSurfaceVariant
    - Completed tasks show strikethrough title text

    **Done section cards:**
    - Same TaskCard but with reduced emphasis (alpha 0.6 or surfaceVariant container)
    - Checkbox shows checked state, tapping uncompletes

    **DeadlineBadge.kt:**
    Small composable showing deadline proximity:
    ```kotlin
    @Composable
    fun DeadlineBadge(
        softDeadline: Instant?,
        hardDeadline: Instant?,
        modifier: Modifier = Modifier
    )
    ```
    - Display the nearest deadline
    - Icon: Icons.Filled.Schedule for soft, Icons.Filled.Flag for hard
    - Text: "Today", "Tomorrow", "In X days", "Yesterday", "X days ago"
    - Color: onSurfaceVariant always (never red/error, even for overdue)
    - Use kotlinx-datetime for date calculations with `TimeZone.currentSystemDefault()`

    **MainActivity.kt:**
    Update to show TaskListScreen directly (temporary — Plan 03 adds navigation):
    ```kotlin
    setContent {
        RoutineToolTheme {
            TaskListScreen(onAddTask = { /* wired in Plan 03 */ })
        }
    }
    ```
  </action>
  <verify>
    `./gradlew assembleDebug` compiles. Launch app on emulator:
    1. Empty state shows "Nothing here yet"
    2. FAB is visible (does nothing yet)
    3. If test data is inserted via Database Inspector: cards render with correct sections, expand/collapse works, completion triggers haptic, deadline badges show correct text
  </verify>
  <done>
    Task list screen renders with sectioned layout (overdue/active/done). Cards expand and collapse with smooth animation. Completion triggers haptic feedback. Deadline badges show neutral, shame-free time indicators. Empty state is calm and minimal. FAB present but not yet wired to navigation.
  </done>
</task>

</tasks>

<verification>
1. `./gradlew assembleDebug` succeeds
2. App launches and shows empty state ("Nothing here yet") with FAB
3. Expandable card animations are smooth (animateContentSize)
4. Haptic feedback fires on task completion checkbox
5. Overdue section uses muted colors, no alarming language
6. Done section shows completed tasks with reduced emphasis
7. Deadline badges display correct relative time text
8. Single card expanded at a time (tapping another collapses the first)
</verification>

<success_criteria>
- TaskListScreen renders three sections correctly based on task state
- TaskCard expands/collapses with animation and shows appropriate content
- Completion triggers haptic feedback (HapticFeedbackConstants.CONFIRM)
- Overdue tasks display neutral "X days ago" language, never "late" or "missed"
- Long-overdue tasks (7+ days) show gentle reschedule suggestion
- Empty state is calm and minimal
- All state managed through single StateFlow in ViewModel
- LazyColumn uses stable keys for performance
- Scaffold contentPadding properly applied (FAB doesn't overlap content)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-quick-capture/01-02-SUMMARY.md`
</output>
