---
phase: 01-foundation-quick-capture
plan: 03
type: execute
wave: 3
depends_on: [01-02]
files_modified:
  - app/src/main/java/com/routinetool/ui/screens/addtask/AddTaskViewModel.kt
  - app/src/main/java/com/routinetool/ui/screens/addtask/AddTaskScreen.kt
  - app/src/main/java/com/routinetool/ui/navigation/NavRoutes.kt
  - app/src/main/java/com/routinetool/ui/navigation/AppNavHost.kt
  - app/src/main/java/com/routinetool/di/AppModule.kt
  - app/src/main/java/com/routinetool/MainActivity.kt
autonomous: false

must_haves:
  truths:
    - "User can add a task with just a title in under 10 seconds from app launch"
    - "New tasks default to no deadline and no importance"
    - "User can optionally add soft or hard deadline without being forced"
    - "User can set details on an existing task at any time"
    - "Overdue tasks can be rescheduled by editing the deadline"
    - "Saving a task returns to the task list where the new task is visible"
  artifacts:
    - path: "app/src/main/java/com/routinetool/ui/screens/addtask/AddTaskScreen.kt"
      provides: "Add/edit task screen composable"
      contains: "fun AddTaskScreen"
    - path: "app/src/main/java/com/routinetool/ui/screens/addtask/AddTaskViewModel.kt"
      provides: "State management for add/edit task"
      contains: "class AddTaskViewModel"
    - path: "app/src/main/java/com/routinetool/ui/navigation/AppNavHost.kt"
      provides: "Navigation graph connecting all screens"
      contains: "fun AppNavHost"
    - path: "app/src/main/java/com/routinetool/ui/navigation/NavRoutes.kt"
      provides: "Route definitions"
      contains: "object NavRoutes"
  key_links:
    - from: "AppNavHost"
      to: "TaskListScreen"
      via: "composable route"
      pattern: "composable.*TaskList"
    - from: "AppNavHost"
      to: "AddTaskScreen"
      via: "composable route"
      pattern: "composable.*AddTask"
    - from: "TaskListScreen FAB"
      to: "AddTask route"
      via: "onAddTask callback navigates"
      pattern: "navController.navigate"
    - from: "AddTaskScreen save"
      to: "TaskList route"
      via: "popBackStack after save"
      pattern: "popBackStack"
---

<objective>
Build the add/edit task screen with progressive disclosure and wire up navigation between all screens, completing the full task capture and management flow.

Purpose: This completes the core user journey — launching the app, capturing a task with minimal friction, and managing it. The "under 10 seconds" capture requirement (CAPT-01) is fulfilled here.
Output: Full working app where user can launch → see tasks → FAB → add task (title only or with details) → save → see in list → tap to expand → edit → complete.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-quick-capture/01-CONTEXT.md
@.planning/phases/01-foundation-quick-capture/01-RESEARCH.md
@.planning/phases/01-foundation-quick-capture/01-01-SUMMARY.md
@.planning/phases/01-foundation-quick-capture/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: AddTaskViewModel and AddTaskScreen with progressive disclosure</name>
  <files>
    app/src/main/java/com/routinetool/ui/screens/addtask/AddTaskViewModel.kt
    app/src/main/java/com/routinetool/ui/screens/addtask/AddTaskScreen.kt
    app/src/main/java/com/routinetool/di/AppModule.kt
  </files>
  <action>
    **AddTaskViewModel.kt:**
    ```kotlin
    data class AddTaskUiState(
        val title: String = "",
        val description: String = "",
        val softDeadline: LocalDate? = null,
        val hardDeadline: LocalDate? = null,
        val showDetails: Boolean = false,
        val isSaving: Boolean = false,
        val isEditMode: Boolean = false,
        val editTaskId: String? = null
    )
    ```

    ViewModel responsibilities:
    - `updateTitle(title: String)` — update title field
    - `updateDescription(desc: String)` — update description
    - `setSoftDeadline(date: LocalDate?)` — set or clear soft deadline
    - `setHardDeadline(date: LocalDate?)` — set or clear hard deadline
    - `toggleDetails()` — expand/collapse the details section
    - `saveTask()` — validate (title not blank), insert or update via repository, return success
    - `loadTask(taskId: String)` — for edit mode: load existing task into state
    - Expose a `savedEvent: SharedFlow<Boolean>` to signal successful save (one-shot event)

    For edit mode: accept optional `taskId` parameter. If provided, load the task and populate state. Save updates instead of inserts.

    **AppModule.kt:** Add `viewModel { params -> AddTaskViewModel(get(), params.getOrNull()) }` for optional taskId parameter.

    **AddTaskScreen.kt:**
    ```kotlin
    @Composable
    fun AddTaskScreen(
        onNavigateBack: () -> Unit,
        taskId: String? = null,  // null = add mode, non-null = edit mode
        viewModel: AddTaskViewModel = koinViewModel { parametersOf(taskId) }
    )
    ```

    Layout:
    - **TopAppBar:** Back arrow (navigateBack), title "New task" or "Edit task"
    - **Content (Column with padding):**
      1. **Title TextField** — large, prominent, auto-focused on entry. Placeholder: "What needs doing?" (neutral, not pushy). Single line. This is the ONLY visible field by default.
      2. **"Add details" TextButton** — below title. Toggles details section. Text changes to "Hide details" when expanded. Uses animateContentSize on the parent column.
      3. **Details section** (only when showDetails = true):
         - **Description TextField** — multi-line, placeholder "Notes (optional)"
         - **Soft deadline row:** Icon (Schedule) + "Reminder date" label + date picker trigger. Shows selected date or "None". Tapping opens Material 3 DatePickerDialog.
         - **Hard deadline row:** Icon (Flag) + "Due date" label + date picker trigger. Same pattern.
         - Each deadline row has a clear (X) button when a date is set
      4. **Save button** — Bottom of screen or as TopAppBar action. Text "Save". Disabled when title is blank. On save: calls viewModel.saveTask(), on success navigates back.

    Date picker: Use Material 3 `DatePickerDialog` with `rememberDatePickerState()`. Convert selected millis to LocalDate using kotlinx-datetime.

    **Key UX decisions:**
    - Title auto-focuses with keyboard shown — capture friction is minimal
    - No required fields except title — CAPT-02 fulfilled
    - Details are hidden by default — progressive disclosure per CONTEXT.md
    - Deadlines are fully optional — TYPE-02 fulfilled
    - Save is instant — no confirmation dialog, no loading spinner visible for local-only DB
    - After save, navigate back to task list (no toast, no "add another" per CONTEXT.md)

    In edit mode: title pre-filled, details auto-expanded if any detail fields are populated, save updates existing task.
  </action>
  <verify>
    `./gradlew assembleDebug` compiles. AddTaskScreen renders with title field, "Add details" expansion works, date pickers open and return dates.
  </verify>
  <done>
    AddTaskScreen shows title field by default with auto-focus. "Add details" reveals description and deadline fields. Date pickers work for both soft and hard deadlines. Save validates non-blank title and persists via repository. Edit mode loads and updates existing tasks.
  </done>
</task>

<task type="auto">
  <name>Task 2: Navigation setup connecting all screens</name>
  <files>
    app/src/main/java/com/routinetool/ui/navigation/NavRoutes.kt
    app/src/main/java/com/routinetool/ui/navigation/AppNavHost.kt
    app/src/main/java/com/routinetool/MainActivity.kt
  </files>
  <action>
    **NavRoutes.kt:**
    Define navigation routes using type-safe Navigation Compose 2.8+ patterns:
    ```kotlin
    object NavRoutes {
        const val TASK_LIST = "task_list"
        const val ADD_TASK = "add_task"
        const val EDIT_TASK = "edit_task/{taskId}"

        fun editTask(taskId: String) = "edit_task/$taskId"
    }
    ```

    **AppNavHost.kt:**
    ```kotlin
    @Composable
    fun AppNavHost(
        navController: NavHostController = rememberNavController()
    ) {
        NavHost(
            navController = navController,
            startDestination = NavRoutes.TASK_LIST
        ) {
            composable(NavRoutes.TASK_LIST) {
                TaskListScreen(
                    onAddTask = { navController.navigate(NavRoutes.ADD_TASK) },
                    onEditTask = { taskId -> navController.navigate(NavRoutes.editTask(taskId)) }
                )
            }
            composable(NavRoutes.ADD_TASK) {
                AddTaskScreen(
                    onNavigateBack = { navController.popBackStack() }
                )
            }
            composable(
                route = NavRoutes.EDIT_TASK,
                arguments = listOf(navArgument("taskId") { type = NavType.StringType })
            ) { backStackEntry ->
                val taskId = backStackEntry.arguments?.getString("taskId")
                AddTaskScreen(
                    onNavigateBack = { navController.popBackStack() },
                    taskId = taskId
                )
            }
        }
    }
    ```

    **Update TaskListScreen signature** (in the existing file from Plan 02):
    Add `onEditTask: (String) -> Unit` parameter. Wire it to expanded card's edit action — when user taps "Edit" in expanded card, navigate to edit screen.

    **Update TaskCard** (in existing file from Plan 02):
    Add an "Edit" text button in the expanded section that triggers `onEditTask(task.id)`.

    **MainActivity.kt:**
    Replace direct TaskListScreen call with AppNavHost:
    ```kotlin
    setContent {
        RoutineToolTheme {
            AppNavHost()
        }
    }
    ```
  </action>
  <verify>
    `./gradlew assembleDebug` compiles. Launch app:
    1. Task list shows as start destination
    2. FAB navigates to add task screen
    3. Back arrow returns to task list
    4. Saving a task returns to task list
    5. Tapping "Edit" in expanded card navigates to edit screen with pre-filled data
    6. Editing and saving returns to task list with updated data
  </verify>
  <done>
    Navigation connects task list ↔ add task ↔ edit task. FAB opens add screen. Save returns to list. Edit opens pre-filled form. Back navigation works correctly. Full capture flow completes in under 10 seconds.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Phase 1 task capture and management flow:
    - Launch app → see task list (or empty state)
    - FAB → add task with just a title → save → see in list
    - Optionally add details (description, soft deadline, hard deadline) via progressive disclosure
    - Tap card to expand → see details, edit button
    - Edit task → change details → save
    - Complete task → haptic feedback → moves to Done section
    - Overdue tasks show in Overdue section with neutral language
    - Long-overdue tasks (7+ days) show gentle reschedule suggestion
  </what-built>
  <how-to-verify>
    Launch the app on an emulator or device and test:

    1. **Empty state:** App opens to "Nothing here yet" with FAB visible
    2. **Quick capture (under 10 seconds):** Tap FAB → type a title → tap Save → task appears in list
    3. **Progressive disclosure:** Tap FAB → tap "Add details" → description field and deadline pickers appear
    4. **Soft deadline:** Add a task with a soft deadline → DeadlineBadge shows Schedule icon with relative date
    5. **Hard deadline:** Add a task with a hard deadline → DeadlineBadge shows Flag icon
    6. **Expand card:** Tap a task card → it expands showing description, deadline details, Edit button
    7. **Edit task:** Tap Edit in expanded card → edit screen opens with pre-filled data → modify and save
    8. **Complete task:** Tap checkbox → feel haptic tap → task moves to Done section with strikethrough
    9. **Uncomplete:** Tap checkbox on done task → moves back to active section
    10. **Overdue handling:** Add a task with a past deadline → appears in Overdue section with "X days ago" text (not "late" or "overdue!")
    11. **Visual check:** Overall aesthetic is clean, monochrome, calm — no bright colors, no playful elements
    12. **Rotation:** Rotate device — expanded state and scroll position preserved
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `./gradlew assembleDebug` succeeds
2. Full user journey works: launch → capture → view → edit → complete
3. Task capture takes under 10 seconds from app launch (CAPT-01)
4. New tasks default to no deadline/importance (CAPT-02)
5. Details can be added at any time via edit (CAPT-03)
6. One-time tasks complete and move to Done section (TYPE-01)
7. Soft and hard deadlines are optional and distinguishable (TYPE-02)
8. No shame/guilt language anywhere (UX-01)
9. Overdue tasks show neutral language, easy to reschedule (UX-02)
10. Visual hierarchy is calm and minimal (UX-04)
11. All data stored locally in Room database (DATA-01)
12. Navigation between screens works correctly with back stack
</verification>

<success_criteria>
- AddTaskScreen captures tasks with title-only in under 10 seconds
- Progressive disclosure hides details behind "Add details" toggle
- Date pickers work for both soft and hard deadlines
- Navigation connects all screens: list ↔ add, list ↔ edit
- Edit mode loads existing task data correctly
- Full Phase 1 user journey verified by human tester
- All 9 Phase 1 requirements (CAPT-01, CAPT-02, CAPT-03, TYPE-01, TYPE-02, UX-01, UX-02, UX-04, DATA-01) satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-quick-capture/01-03-SUMMARY.md`
</output>
