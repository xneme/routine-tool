---
phase: 02-organization-focus
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - gradle/libs.versions.toml
  - app/build.gradle.kts
  - app/src/main/java/com/routinetool/data/preferences/PreferencesDataStore.kt
  - app/src/main/java/com/routinetool/domain/model/SortOption.kt
  - app/src/main/java/com/routinetool/domain/model/FilterState.kt
  - app/src/main/java/com/routinetool/di/AppModule.kt
autonomous: true

must_haves:
  truths:
    - "DataStore preference can be read and written without blocking main thread"
    - "Sort preference survives app restart"
    - "Filter state is not persisted (resets on app restart)"
    - "Focus config (task limit, pinned IDs) survives app restart"
    - "Edit expansion states survive app restart"
  artifacts:
    - path: "app/src/main/java/com/routinetool/data/preferences/PreferencesDataStore.kt"
      provides: "Preferences DataStore wrapper with sort, focus config, expansion states"
      exports: ["PreferencesDataStore"]
    - path: "app/src/main/java/com/routinetool/domain/model/SortOption.kt"
      provides: "Sort option enum with display names and comparators"
      exports: ["SortOption"]
    - path: "app/src/main/java/com/routinetool/domain/model/FilterState.kt"
      provides: "Filter state data class with status and deadline type filters"
      exports: ["FilterState"]
  key_links:
    - from: "PreferencesDataStore"
      to: "DataStore<Preferences>"
      via: "Context.dataStore extension"
      pattern: "preferencesDataStore.*name.*settings"
    - from: "AppModule"
      to: "PreferencesDataStore"
      via: "Koin single definition"
      pattern: "single.*PreferencesDataStore"
---

<objective>
Add DataStore preference infrastructure for persisting sort options, focus view configuration, and edit screen expansion states.

Purpose: Foundation layer for Phase 2 features - enables sorting persistence, focus view task limit config, and progressive disclosure state memory.

Output: PreferencesDataStore class with Flow-based async access, SortOption enum, FilterState data class, Koin registration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-organization-focus/02-CONTEXT.md
@.planning/phases/02-organization-focus/02-RESEARCH.md
@gradle/libs.versions.toml
@app/build.gradle.kts
@app/src/main/java/com/routinetool/di/AppModule.kt
@app/src/main/java/com/routinetool/domain/model/Task.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add DataStore dependency to build files</name>
  <files>
    gradle/libs.versions.toml
    app/build.gradle.kts
  </files>
  <action>
1. In gradle/libs.versions.toml:
   - Add version: `datastore = "1.1.1"` (latest stable)
   - Add library: `datastore-preferences = { group = "androidx.datastore", name = "datastore-preferences", version.ref = "datastore" }`

2. In app/build.gradle.kts:
   - Add dependency: `implementation(libs.datastore.preferences)`
   - Place it after the Room dependencies for logical grouping
  </action>
  <verify>
Run `./gradlew :app:dependencies --configuration releaseRuntimeClasspath | grep datastore` and verify datastore-preferences appears.
  </verify>
  <done>
DataStore preferences library is added to project dependencies and resolved successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PreferencesDataStore, SortOption, and FilterState</name>
  <files>
    app/src/main/java/com/routinetool/data/preferences/PreferencesDataStore.kt
    app/src/main/java/com/routinetool/domain/model/SortOption.kt
    app/src/main/java/com/routinetool/domain/model/FilterState.kt
  </files>
  <action>
1. Create `SortOption.kt` in domain/model:
```kotlin
package com.routinetool.domain.model

import com.routinetool.domain.model.Task

enum class SortOption(val displayName: String) {
    URGENCY("Urgency"),
    DEADLINE("Deadline"),
    CREATED("Created");

    fun comparator(): Comparator<Task> = when (this) {
        URGENCY -> compareBy(
            { task ->
                val nearestDeadline = listOfNotNull(task.softDeadline, task.hardDeadline).minOrNull()
                if (nearestDeadline != null && nearestDeadline.toEpochMilliseconds() < System.currentTimeMillis()) 0 else 1
            },
            { task -> listOfNotNull(task.softDeadline, task.hardDeadline).minOrNull()?.toEpochMilliseconds() ?: Long.MAX_VALUE }
        )
        DEADLINE -> compareBy { task ->
            listOfNotNull(task.softDeadline, task.hardDeadline).minOrNull()?.toEpochMilliseconds() ?: Long.MAX_VALUE
        }
        CREATED -> compareByDescending { it.createdAt.toEpochMilliseconds() }
    }
}
```

2. Create `FilterState.kt` in domain/model:
```kotlin
package com.routinetool.domain.model

data class FilterState(
    val showActive: Boolean = true,
    val showOverdue: Boolean = true,
    val showDone: Boolean = true,
    val showSoftDeadline: Boolean = true,
    val showHardDeadline: Boolean = true,
    val showNoDeadline: Boolean = true
) {
    val isDefault: Boolean
        get() = showActive && showOverdue && showDone && showSoftDeadline && showHardDeadline && showNoDeadline
}
```

3. Create `PreferencesDataStore.kt` in data/preferences (new package):
```kotlin
package com.routinetool.data.preferences

import android.content.Context
import androidx.datastore.core.DataStore
import androidx.datastore.preferences.core.Preferences
import androidx.datastore.preferences.core.booleanPreferencesKey
import androidx.datastore.preferences.core.edit
import androidx.datastore.preferences.core.intPreferencesKey
import androidx.datastore.preferences.core.stringPreferencesKey
import androidx.datastore.preferences.core.stringSetPreferencesKey
import androidx.datastore.preferences.preferencesDataStore
import com.routinetool.domain.model.SortOption
import kotlinx.coroutines.flow.Flow
import kotlinx.coroutines.flow.map

private val Context.dataStore: DataStore<Preferences> by preferencesDataStore(name = "settings")

class PreferencesDataStore(private val context: Context) {

    // Sort preference
    private val SORT_PREFERENCE_KEY = stringPreferencesKey("sort_preference")

    val sortPreference: Flow<SortOption> = context.dataStore.data.map { prefs ->
        prefs[SORT_PREFERENCE_KEY]?.let {
            try { SortOption.valueOf(it) } catch (e: IllegalArgumentException) { SortOption.URGENCY }
        } ?: SortOption.URGENCY
    }

    suspend fun saveSortPreference(option: SortOption) {
        context.dataStore.edit { prefs ->
            prefs[SORT_PREFERENCE_KEY] = option.name
        }
    }

    // Focus config
    private val FOCUS_TASK_LIMIT_KEY = intPreferencesKey("focus_task_limit")
    private val FOCUS_PINNED_TASK_IDS_KEY = stringSetPreferencesKey("focus_pinned_task_ids")

    val focusTaskLimit: Flow<Int> = context.dataStore.data.map { prefs ->
        prefs[FOCUS_TASK_LIMIT_KEY] ?: 5  // Default 5 tasks (cognitive comfort zone)
    }

    val focusPinnedTaskIds: Flow<Set<String>> = context.dataStore.data.map { prefs ->
        prefs[FOCUS_PINNED_TASK_IDS_KEY] ?: emptySet()
    }

    suspend fun saveFocusTaskLimit(limit: Int) {
        context.dataStore.edit { prefs ->
            prefs[FOCUS_TASK_LIMIT_KEY] = limit
        }
    }

    suspend fun saveFocusPinnedTaskIds(ids: Set<String>) {
        context.dataStore.edit { prefs ->
            prefs[FOCUS_PINNED_TASK_IDS_KEY] = ids
        }
    }

    // Edit screen expansion states
    private val NOTES_EXPANDED_KEY = booleanPreferencesKey("notes_expanded")
    private val DEADLINES_EXPANDED_KEY = booleanPreferencesKey("deadlines_expanded")

    val notesExpanded: Flow<Boolean> = context.dataStore.data.map { prefs ->
        prefs[NOTES_EXPANDED_KEY] ?: false
    }

    val deadlinesExpanded: Flow<Boolean> = context.dataStore.data.map { prefs ->
        prefs[DEADLINES_EXPANDED_KEY] ?: false
    }

    suspend fun saveNotesExpanded(expanded: Boolean) {
        context.dataStore.edit { prefs ->
            prefs[NOTES_EXPANDED_KEY] = expanded
        }
    }

    suspend fun saveDeadlinesExpanded(expanded: Boolean) {
        context.dataStore.edit { prefs ->
            prefs[DEADLINES_EXPANDED_KEY] = expanded
        }
    }
}
```
  </action>
  <verify>
Build the project with `./gradlew :app:compileDebugKotlin`. No compilation errors should occur.
  </verify>
  <done>
PreferencesDataStore, SortOption, and FilterState classes exist with Flow-based async access for all Phase 2 preferences.
  </done>
</task>

<task type="auto">
  <name>Task 3: Register PreferencesDataStore in Koin</name>
  <files>
    app/src/main/java/com/routinetool/di/AppModule.kt
  </files>
  <action>
Update AppModule.kt to register PreferencesDataStore as a singleton:

1. Add import: `import com.routinetool.data.preferences.PreferencesDataStore`

2. Add singleton definition after the Repository definition:
```kotlin
// Preferences DataStore
single { PreferencesDataStore(androidContext()) }
```

Do NOT modify ViewModels yet - they will be updated in Plan 02.
  </action>
  <verify>
Build the project with `./gradlew :app:assembleDebug`. App should build successfully with Koin module containing PreferencesDataStore.
  </verify>
  <done>
PreferencesDataStore is registered as Koin singleton and can be injected into ViewModels.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Run `./gradlew :app:assembleDebug` - project builds without errors
2. Verify files exist:
   - `app/src/main/java/com/routinetool/data/preferences/PreferencesDataStore.kt`
   - `app/src/main/java/com/routinetool/domain/model/SortOption.kt`
   - `app/src/main/java/com/routinetool/domain/model/FilterState.kt`
3. Verify SortOption has 3 values: URGENCY, DEADLINE, CREATED
4. Verify FilterState has 6 boolean fields
5. Verify PreferencesDataStore has Flows for: sortPreference, focusTaskLimit, focusPinnedTaskIds, notesExpanded, deadlinesExpanded
6. Verify AppModule registers PreferencesDataStore as singleton
</verification>

<success_criteria>
- DataStore dependency added and resolved
- PreferencesDataStore class provides async Flow access to all preferences
- SortOption enum has comparators that match RESEARCH.md patterns
- FilterState data class supports status and deadline type filtering
- Koin can inject PreferencesDataStore into ViewModels
- Project compiles successfully
</success_criteria>

<output>
After completion, create `.planning/phases/02-organization-focus/02-01-SUMMARY.md`
</output>
