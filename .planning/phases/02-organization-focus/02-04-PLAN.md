---
phase: 02-organization-focus
plan: 04
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - app/src/main/java/com/routinetool/ui/screens/addtask/AddTaskScreen.kt
  - app/src/main/java/com/routinetool/ui/screens/addtask/AddTaskViewModel.kt
autonomous: true

must_haves:
  truths:
    - "Notes field is hidden behind expandable section header"
    - "Deadline options are hidden behind expandable section header"
    - "Tapping section header expands/collapses content"
    - "Expansion state persists between edit sessions"
    - "User can still save task when sections are collapsed"
  artifacts:
    - path: "app/src/main/java/com/routinetool/ui/screens/addtask/AddTaskScreen.kt"
      provides: "Edit screen with expandable sections for Notes and Deadlines"
      min_lines: 200
    - path: "app/src/main/java/com/routinetool/ui/screens/addtask/AddTaskViewModel.kt"
      provides: "ViewModel with expansion state persistence"
  key_links:
    - from: "AddTaskViewModel"
      to: "PreferencesDataStore"
      via: "Koin injection"
      pattern: "AddTaskViewModel.*PreferencesDataStore"
    - from: "AddTaskScreen"
      to: "AnimatedVisibility"
      via: "Compose animation"
      pattern: "AnimatedVisibility.*expandVertically"
---

<objective>
Enhance Add/Edit Task screen with progressive disclosure using expandable sections.

Purpose: Success criteria 5 (task editing reveals details through expandable sections) - reduces visual clutter and cognitive load for neurodivergent users.

Output: AddTaskScreen with collapsible Notes and Deadlines sections, persistent expansion state.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-organization-focus/02-CONTEXT.md
@.planning/phases/02-organization-focus/02-RESEARCH.md
@.planning/phases/02-organization-focus/02-01-SUMMARY.md

@app/src/main/java/com/routinetool/ui/screens/addtask/AddTaskScreen.kt
@app/src/main/java/com/routinetool/ui/screens/addtask/AddTaskViewModel.kt
@app/src/main/java/com/routinetool/data/preferences/PreferencesDataStore.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update AddTaskViewModel for expansion state persistence</name>
  <files>
    app/src/main/java/com/routinetool/ui/screens/addtask/AddTaskViewModel.kt
    app/src/main/java/com/routinetool/di/AppModule.kt
  </files>
  <action>
1. Update AppModule.kt to inject PreferencesDataStore into AddTaskViewModel:
```kotlin
viewModel { params -> AddTaskViewModel(get(), get(), params.getOrNull()) }
```
Note: Order is repository, dataStore, taskId

2. Update AddTaskViewModel.kt:
   - Add PreferencesDataStore as second constructor parameter
   - Add StateFlows for notesExpanded and deadlinesExpanded from PreferencesDataStore
   - Add functions to toggle and persist expansion state
   - Remove old showDetails toggle (replace with section-specific expansion)

```kotlin
class AddTaskViewModel(
    private val repository: TaskRepository,
    private val preferencesDataStore: PreferencesDataStore,
    private val taskId: String? = null
) : ViewModel() {

    // Expansion state from DataStore (persists across sessions)
    val notesExpanded: StateFlow<Boolean> = preferencesDataStore.notesExpanded
        .stateIn(viewModelScope, SharingStarted.WhileSubscribed(5000), false)

    val deadlinesExpanded: StateFlow<Boolean> = preferencesDataStore.deadlinesExpanded
        .stateIn(viewModelScope, SharingStarted.WhileSubscribed(5000), false)

    fun toggleNotesExpanded() {
        viewModelScope.launch {
            preferencesDataStore.saveNotesExpanded(!notesExpanded.value)
        }
    }

    fun toggleDeadlinesExpanded() {
        viewModelScope.launch {
            preferencesDataStore.saveDeadlinesExpanded(!deadlinesExpanded.value)
        }
    }

    // ... rest of existing code ...
}
```

3. Update AddTaskUiState to remove showDetails field (no longer needed - expansion tracked separately)
  </action>
  <verify>
Build with `./gradlew :app:compileDebugKotlin`. No compilation errors.
  </verify>
  <done>
AddTaskViewModel manages persistent expansion state for Notes and Deadlines sections.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor AddTaskScreen with expandable sections</name>
  <files>
    app/src/main/java/com/routinetool/ui/screens/addtask/AddTaskScreen.kt
  </files>
  <action>
Refactor AddTaskScreen.kt to use expandable sections per RESEARCH.md pattern:

1. Add imports:
```kotlin
import androidx.compose.animation.AnimatedVisibility
import androidx.compose.animation.expandVertically
import androidx.compose.animation.shrinkVertically
import androidx.compose.animation.fadeIn
import androidx.compose.animation.fadeOut
import androidx.compose.foundation.clickable
import androidx.compose.material.icons.filled.ExpandLess
import androidx.compose.material.icons.filled.ExpandMore
```

2. Create ExpandableSection composable:
```kotlin
@Composable
private fun ExpandableSection(
    title: String,
    expanded: Boolean,
    onToggle: () -> Unit,
    modifier: Modifier = Modifier,
    content: @Composable () -> Unit
) {
    Column(modifier = modifier) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .clickable(onClick = onToggle)
                .padding(vertical = 12.dp),
            horizontalArrangement = Arrangement.SpaceBetween,
            verticalAlignment = Alignment.CenterVertically
        ) {
            Text(
                text = title,
                style = MaterialTheme.typography.titleSmall,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )
            Icon(
                imageVector = if (expanded) Icons.Default.ExpandLess else Icons.Default.ExpandMore,
                contentDescription = if (expanded) "Collapse" else "Expand",
                tint = MaterialTheme.colorScheme.onSurfaceVariant
            )
        }

        AnimatedVisibility(
            visible = expanded,
            enter = expandVertically(expandFrom = Alignment.Top) + fadeIn(),
            exit = shrinkVertically(shrinkTowards = Alignment.Top) + fadeOut()
        ) {
            content()
        }
    }
}
```

3. Update AddTaskScreen main composable:
   - Collect notesExpanded and deadlinesExpanded from viewModel
   - Remove old "Add details" / "Hide details" toggle button
   - Replace with two ExpandableSection composables:
     - "Notes" section containing description OutlinedTextField
     - "Deadlines" section containing soft and hard deadline pickers

4. Structure:
```
[Title field - always visible]

▼ Notes
  [Description field - when expanded]

▼ Deadlines
  [Soft deadline picker - when expanded]
  [Hard deadline picker - when expanded]
```

5. Keep existing DeadlinePicker composable unchanged.

6. Remove references to uiState.showDetails and viewModel.toggleDetails()
  </action>
  <verify>
Build and run app. Verify:
1. Title field always visible
2. "Notes" section header shows with expand/collapse icon
3. Tapping "Notes" expands to show description field
4. "Deadlines" section header shows with expand/collapse icon
5. Tapping "Deadlines" expands to show deadline pickers
6. Expansion state persists: close app, reopen, edit a task - sections stay expanded/collapsed as before
7. Can save task with sections collapsed (title is only required field)
  </verify>
  <done>
AddTaskScreen uses expandable sections for Notes and Deadlines with persistent expansion state.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Build: `./gradlew :app:assembleDebug` succeeds
2. Run app and verify:
   - Add new task: only title visible initially
   - "Notes" section header visible, collapsed by default
   - "Deadlines" section header visible, collapsed by default
   - Tapping section header expands/collapses with animation
   - Expand Notes, close app, reopen, add new task: Notes still expanded
   - Expand Deadlines, edit existing task: Deadlines still expanded
   - Can save task with both sections collapsed
   - Can save task with notes but no deadlines
   - All previous functionality still works
</verification>

<success_criteria>
- Notes field behind expandable "Notes" section
- Deadline pickers behind expandable "Deadlines" section
- Section headers show expand/collapse icon
- AnimatedVisibility with expandVertically animation
- Expansion state persists via DataStore
- Task can be saved regardless of expansion state
- No regression in existing add/edit functionality
</success_criteria>

<output>
After completion, create `.planning/phases/02-organization-focus/02-04-SUMMARY.md`
</output>
