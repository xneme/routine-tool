---
phase: 03-structure-breakdown
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/src/main/java/com/routinetool/data/local/entities/SubtaskEntity.kt
  - app/src/main/java/com/routinetool/data/local/entities/TaskWithSubtasksEntity.kt
  - app/src/main/java/com/routinetool/data/local/database/SubtaskDao.kt
  - app/src/main/java/com/routinetool/data/local/database/AppDatabase.kt
  - app/src/main/java/com/routinetool/domain/model/Subtask.kt
  - app/src/main/java/com/routinetool/data/repository/TaskRepository.kt
  - app/src/main/java/com/routinetool/di/AppModule.kt
autonomous: true

must_haves:
  truths:
    - "Subtasks can be created and persisted in the database"
    - "Subtasks are associated with their parent task"
    - "Deleting a task cascades to delete its subtasks"
    - "Subtasks maintain their position order across app restarts"
    - "Completion timestamps are recorded when subtasks are marked complete"
  artifacts:
    - path: "app/src/main/java/com/routinetool/data/local/entities/SubtaskEntity.kt"
      provides: "Room entity for subtasks with foreign key"
      contains: "@Entity"
    - path: "app/src/main/java/com/routinetool/data/local/database/SubtaskDao.kt"
      provides: "DAO for subtask CRUD operations"
      exports: ["SubtaskDao"]
    - path: "app/src/main/java/com/routinetool/domain/model/Subtask.kt"
      provides: "Domain model for subtask"
      contains: "data class Subtask"
  key_links:
    - from: "SubtaskEntity"
      to: "TaskEntity"
      via: "ForeignKey with CASCADE delete"
      pattern: "ForeignKey.*onDelete.*CASCADE"
    - from: "TaskRepository"
      to: "SubtaskDao"
      via: "constructor injection"
      pattern: "SubtaskDao"
---

<objective>
Create the subtask data layer with Room entity, DAO, and repository methods.

Purpose: Establish the foundation for subtask storage and retrieval that all UI components will depend on.
Output: SubtaskEntity with foreign key relationship to TaskEntity, SubtaskDao with CRUD operations, domain model, and repository methods for subtask management.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-structure-breakdown/03-CONTEXT.md
@.planning/phases/03-structure-breakdown/03-RESEARCH.md

@app/src/main/java/com/routinetool/data/local/entities/TaskEntity.kt
@app/src/main/java/com/routinetool/data/local/database/TaskDao.kt
@app/src/main/java/com/routinetool/data/local/database/AppDatabase.kt
@app/src/main/java/com/routinetool/domain/model/Task.kt
@app/src/main/java/com/routinetool/data/repository/TaskRepository.kt
@app/src/main/java/com/routinetool/di/AppModule.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SubtaskEntity and relation model</name>
  <files>
    app/src/main/java/com/routinetool/data/local/entities/SubtaskEntity.kt
    app/src/main/java/com/routinetool/data/local/entities/TaskWithSubtasksEntity.kt
  </files>
  <action>
Create SubtaskEntity with:
- @Entity with tableName = "subtasks"
- ForeignKey referencing TaskEntity with CASCADE delete
- Index on taskId column for query performance
- Fields: id (String, PrimaryKey, UUID default), taskId (String), title (String), isCompleted (Boolean, default false), completedAt (Long?, default null), position (Float for fractional indexing), createdAt (Long, default currentTimeMillis)

Create TaskWithSubtasksEntity relation model with:
- @Embedded TaskEntity as `task`
- @Relation for subtasks with parentColumn = "id", entityColumn = "taskId"
- List<SubtaskEntity> as `subtasks`

Follow existing entity patterns from TaskEntity.kt for consistency. Use Long for timestamps (epoch millis) matching existing pattern.
  </action>
  <verify>
Build compiles: `cd /home/xneme/Programming/routine-tool && ./gradlew assembleDebug 2>&1 | tail -20`
  </verify>
  <done>
SubtaskEntity exists with proper ForeignKey and Index annotations. TaskWithSubtasksEntity exists with @Embedded and @Relation annotations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SubtaskDao and update AppDatabase</name>
  <files>
    app/src/main/java/com/routinetool/data/local/database/SubtaskDao.kt
    app/src/main/java/com/routinetool/data/local/database/AppDatabase.kt
  </files>
  <action>
Create SubtaskDao interface with:
- @Insert with OnConflictStrategy.REPLACE
- @Update
- @Delete
- @Query to get subtasks by taskId, ordered by position ASC
- @Query to observe subtasks by taskId as Flow<List<SubtaskEntity>>
- @Query to get single subtask by id
- @Query to update position: `UPDATE subtasks SET position = :position WHERE id = :id`
- @Query to toggle completion: separate queries for complete (set completedAt) and uncomplete (clear completedAt)

Update AppDatabase:
- Add SubtaskEntity to entities array
- Increment version to 2
- Add abstract fun subtaskDao(): SubtaskDao
- Add migration from version 1 to 2 that creates the subtasks table with all columns, foreign key, and index

Migration SQL should be:
```sql
CREATE TABLE IF NOT EXISTS subtasks (
    id TEXT NOT NULL PRIMARY KEY,
    taskId TEXT NOT NULL,
    title TEXT NOT NULL,
    isCompleted INTEGER NOT NULL DEFAULT 0,
    completedAt INTEGER,
    position REAL NOT NULL,
    createdAt INTEGER NOT NULL,
    FOREIGN KEY (taskId) REFERENCES tasks(id) ON DELETE CASCADE
);
CREATE INDEX IF NOT EXISTS index_subtasks_taskId ON subtasks(taskId);
```

Register the migration in the database builder in AppModule.kt.
  </action>
  <verify>
Build compiles and schema exports: `cd /home/xneme/Programming/routine-tool && ./gradlew assembleDebug 2>&1 | tail -20`
Check schema file created: `ls -la /home/xneme/Programming/routine-tool/app/schemas/`
  </verify>
  <done>
SubtaskDao exists with all CRUD operations. AppDatabase is version 2 with SubtaskEntity and migration. Schema exports to schemas/ directory.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create domain model and repository methods</name>
  <files>
    app/src/main/java/com/routinetool/domain/model/Subtask.kt
    app/src/main/java/com/routinetool/data/repository/TaskRepository.kt
    app/src/main/java/com/routinetool/di/AppModule.kt
  </files>
  <action>
Create Subtask domain model with:
- id: String
- taskId: String
- title: String
- isCompleted: Boolean
- completedAt: Instant? (using kotlinx.datetime, matching Task pattern)
- position: Float
- createdAt: Instant

Add to TaskRepository:
- Constructor parameter for SubtaskDao
- Extension function SubtaskEntity.toDomainModel() -> Subtask (matching existing pattern)
- Extension function Subtask.toEntity() -> SubtaskEntity
- `observeSubtasks(taskId: String): Flow<List<Subtask>>` - returns subtasks ordered by position
- `addSubtask(taskId: String, title: String)` - calculates next position (maxPosition + 1f, or 0f if empty)
- `toggleSubtask(subtaskId: String)` - if completed, uncomplete (clear completedAt); if not, complete (set completedAt to now)
- `deleteSubtask(subtaskId: String)`
- `reorderSubtask(subtaskId: String, newIndex: Int, allSubtasks: List<Subtask>)` - implements fractional indexing:
  - If newIndex == 0: position = first.position - 1f (or 0f if empty)
  - If newIndex >= size: position = last.position + 1f
  - Else: position = (prev.position + next.position) / 2f
  - Check for precision loss (gap < 0.0001f) and renumber if needed

Update AppModule.kt:
- Inject SubtaskDao into TaskRepository: `single { TaskRepository(get(), get()) }` where second get() is subtaskDao
- Ensure subtaskDao is provided: `single { get<AppDatabase>().subtaskDao() }`
  </action>
  <verify>
Build compiles: `cd /home/xneme/Programming/routine-tool && ./gradlew assembleDebug 2>&1 | tail -20`
  </verify>
  <done>
Subtask domain model exists. TaskRepository has all subtask methods with fractional indexing logic. AppModule provides SubtaskDao to TaskRepository.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Build succeeds: `./gradlew assembleDebug`
2. Schema file exists at version 2 in schemas/ directory
3. No Room compiler warnings about missing indices
4. SubtaskDao, SubtaskEntity, Subtask domain model all exist
5. TaskRepository has observeSubtasks, addSubtask, toggleSubtask, deleteSubtask, reorderSubtask methods
</verification>

<success_criteria>
- SubtaskEntity has ForeignKey with CASCADE delete to TaskEntity
- SubtaskEntity has Index on taskId
- Database migration from v1 to v2 is defined
- Domain model uses Instant for timestamps (matching Task pattern)
- Repository methods implement fractional indexing for reordering
- Build compiles with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-structure-breakdown/03-01-SUMMARY.md`
</output>
