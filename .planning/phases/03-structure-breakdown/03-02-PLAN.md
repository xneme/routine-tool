---
phase: 03-structure-breakdown
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - gradle/libs.versions.toml
  - app/build.gradle.kts
  - app/src/main/java/com/routinetool/ui/screens/addtask/AddTaskViewModel.kt
  - app/src/main/java/com/routinetool/ui/screens/addtask/AddTaskScreen.kt
  - app/src/main/java/com/routinetool/data/preferences/PreferencesDataStore.kt
autonomous: true

must_haves:
  truths:
    - "User can add subtasks from the edit task screen"
    - "User can see existing subtasks in an expandable section"
    - "User can reorder subtasks by long-press drag"
    - "User sees a warning when adding many subtasks (soft limit)"
    - "Subtasks expansion state persists across sessions"
  artifacts:
    - path: "app/src/main/java/com/routinetool/ui/screens/addtask/AddTaskScreen.kt"
      provides: "Subtasks expandable section with reorderable list"
      contains: "ReorderableItem"
    - path: "app/src/main/java/com/routinetool/ui/screens/addtask/AddTaskViewModel.kt"
      provides: "Subtask state management"
      contains: "subtasks"
  key_links:
    - from: "AddTaskScreen"
      to: "AddTaskViewModel"
      via: "subtask actions (add, reorder, delete)"
      pattern: "viewModel\\.addSubtask|viewModel\\.reorderSubtask"
    - from: "AddTaskViewModel"
      to: "TaskRepository"
      via: "subtask repository methods"
      pattern: "repository\\.(addSubtask|toggleSubtask|reorderSubtask)"
---

<objective>
Implement subtask management UI on the edit task screen with reorderable list.

Purpose: Enable users to add and organize subtasks directly when editing a task, using the existing progressive disclosure pattern.
Output: Expandable "Subtasks" section with inline add field, reorderable list with long-press drag, and soft limit warning.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-structure-breakdown/03-CONTEXT.md
@.planning/phases/03-structure-breakdown/03-RESEARCH.md
@.planning/phases/03-structure-breakdown/03-01-SUMMARY.md

@app/src/main/java/com/routinetool/ui/screens/addtask/AddTaskScreen.kt
@app/src/main/java/com/routinetool/ui/screens/addtask/AddTaskViewModel.kt
@app/src/main/java/com/routinetool/data/preferences/PreferencesDataStore.kt
@app/src/main/java/com/routinetool/data/repository/TaskRepository.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add reorderable library dependency</name>
  <files>
    gradle/libs.versions.toml
    app/build.gradle.kts
  </files>
  <action>
Add sh.calvin.reorderable library to the project:

In gradle/libs.versions.toml, add to [versions]:
```
reorderable = "3.0.0"
```

In [libraries]:
```
reorderable = { module = "sh.calvin.reorderable:reorderable", version.ref = "reorderable" }
```

In app/build.gradle.kts dependencies, add:
```
implementation(libs.reorderable)
```

This library provides:
- rememberReorderableLazyListState for tracking drag state
- ReorderableItem composable wrapper
- longPressDraggableHandle modifier for long-press activation
- Automatic animateItem integration for smooth animations
  </action>
  <verify>
Sync gradle and verify dependency resolves: `cd /home/xneme/Programming/routine-tool && ./gradlew dependencies --configuration releaseRuntimeClasspath 2>&1 | grep -i reorderable`
  </verify>
  <done>
Reorderable library version 3.0.0 is in version catalog and app dependencies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add subtasks expansion state to DataStore and ViewModel</name>
  <files>
    app/src/main/java/com/routinetool/data/preferences/PreferencesDataStore.kt
    app/src/main/java/com/routinetool/ui/screens/addtask/AddTaskViewModel.kt
  </files>
  <action>
In PreferencesDataStore, add (following existing pattern for notesExpanded/deadlinesExpanded):
- Private key: `private val SUBTASKS_EXPANDED = booleanPreferencesKey("subtasks_expanded")`
- Public Flow: `val subtasksExpanded: Flow<Boolean> = dataStore.data.map { it[SUBTASKS_EXPANDED] ?: false }`
- Save function: `suspend fun saveSubtasksExpanded(expanded: Boolean)`

In AddTaskViewModel:
- Add subtasksExpanded StateFlow (same pattern as notesExpanded/deadlinesExpanded)
- Add `toggleSubtasksExpanded()` function
- Add private `_subtasks = MutableStateFlow<List<Subtask>>(emptyList())`
- Add public `subtasks: StateFlow<List<Subtask>>`
- In `loadTask()`, also observe subtasks: `repository.observeSubtasks(id).collect { _subtasks.value = it }`
- Add `addSubtask(title: String)` - calls repository.addSubtask with current task's id (editTaskId)
- Add `deleteSubtask(subtaskId: String)` - calls repository.deleteSubtask
- Add `reorderSubtask(fromIndex: Int, toIndex: Int)` - get current subtasks, calculate new position using repository.reorderSubtask

For new tasks (not edit mode), subtasks are added to a local list first, then saved when the task is saved. Modify saveTask() to:
- After inserting new task, iterate through local subtasks and call repository.addSubtask for each
- This means we need a separate `pendingSubtasks: MutableStateFlow<List<String>>` for new task mode (just titles, not full Subtask objects)
- When in edit mode, subtasks are saved immediately via repository
- When in add mode, subtasks are collected and saved after task creation

Add `isSubtaskLimitWarningVisible: StateFlow<Boolean>` that emits true when subtasks.size >= 20.
  </action>
  <verify>
Build compiles: `cd /home/xneme/Programming/routine-tool && ./gradlew assembleDebug 2>&1 | tail -20`
  </verify>
  <done>
PreferencesDataStore has subtasksExpanded preference. AddTaskViewModel has subtask state management with add/delete/reorder functions and limit warning state.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement Subtasks UI section on edit screen</name>
  <files>
    app/src/main/java/com/routinetool/ui/screens/addtask/AddTaskScreen.kt
  </files>
  <action>
Add Subtasks ExpandableSection after Deadlines section, following the same pattern:

1. Collect state from ViewModel:
```kotlin
val subtasksExpanded by viewModel.subtasksExpanded.collectAsState()
val subtasks by viewModel.subtasks.collectAsState()
val showSubtaskLimitWarning by viewModel.isSubtaskLimitWarningVisible.collectAsState()
```

2. Create ExpandableSection with title "Subtasks":
```kotlin
ExpandableSection(
    title = "Subtasks",
    expanded = subtasksExpanded,
    onToggle = { viewModel.toggleSubtasksExpanded() }
) {
    SubtasksList(
        subtasks = subtasks,
        onAddSubtask = { viewModel.addSubtask(it) },
        onDeleteSubtask = { viewModel.deleteSubtask(it) },
        onReorder = { from, to -> viewModel.reorderSubtask(from, to) },
        showLimitWarning = showSubtaskLimitWarning
    )
}
```

3. Create SubtasksList composable within the file (or as private composable):
- Use `rememberLazyListState()` and `rememberReorderableLazyListState(lazyListState) { from, to -> onReorder(from.index, to.index) }`
- LazyColumn with `items(subtasks, key = { it.id })`
- Each item wrapped in `ReorderableItem(reorderableState, key = subtask.id) { isDragging -> ... }`
- SubtaskRow: Row with checkbox (unchecked state display, not toggleable here - toggle is from task list view) + title + delete IconButton
- Apply `Modifier.longPressDraggableHandle()` to the row
- Animate elevation: `val elevation by animateDpAsState(if (isDragging) 8.dp else 0.dp)`
- Apply shadow: `Modifier.shadow(elevation, RoundedCornerShape(4.dp))`
- Add haptic feedback on drag start/stop using HapticFeedbackConstants.LONG_PRESS and VIRTUAL_KEY_RELEASE

4. At end of subtask list, add inline TextField for new subtask:
```kotlin
var newSubtaskTitle by remember { mutableStateOf("") }

OutlinedTextField(
    value = newSubtaskTitle,
    onValueChange = { newSubtaskTitle = it },
    placeholder = { Text("Add subtask") },
    keyboardOptions = KeyboardOptions(imeAction = ImeAction.Done),
    keyboardActions = KeyboardActions(
        onDone = {
            if (newSubtaskTitle.isNotBlank()) {
                onAddSubtask(newSubtaskTitle.trim())
                newSubtaskTitle = ""
            }
        }
    ),
    singleLine = true,
    modifier = Modifier.fillMaxWidth()
)
```

5. Show soft limit warning when showLimitWarning is true:
```kotlin
if (showLimitWarning) {
    Text(
        text = "This task has many steps. Consider breaking it into separate tasks for better focus.",
        style = MaterialTheme.typography.bodySmall,
        color = MaterialTheme.colorScheme.onSurfaceVariant,
        modifier = Modifier.padding(top = 8.dp)
    )
}
```

Import necessary classes:
- sh.calvin.reorderable.*
- HapticFeedbackConstants
- animateDpAsState
- RoundedCornerShape
- shadow modifier
  </action>
  <verify>
Build compiles: `cd /home/xneme/Programming/routine-tool && ./gradlew assembleDebug 2>&1 | tail -20`
Install and test: open app, create task, edit it, expand Subtasks section, add subtasks, verify reordering works via long-press drag.
  </verify>
  <done>
Subtasks section appears on edit screen with expandable visibility. Inline text field allows adding subtasks. Long-press drag reorders subtasks with elevation animation and haptic feedback. Soft limit warning shows at 20+ subtasks.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Build succeeds: `./gradlew assembleDebug`
2. Reorderable library is included in dependencies
3. Subtasks section visible in edit task screen
4. Can add subtasks via inline text field
5. Can reorder subtasks via long-press drag
6. Elevation and shadow visible during drag
7. Haptic feedback on drag start/end
8. Warning appears at 20+ subtasks
9. Expansion state persists across app restarts
</verification>

<success_criteria>
- sh.calvin.reorderable library added to project
- Subtasks ExpandableSection on edit screen (after Deadlines)
- Inline TextField for adding subtasks
- Long-press drag reordering with visual feedback (shadow elevation)
- Haptic feedback: LONG_PRESS on drag start, VIRTUAL_KEY_RELEASE on drag stop
- Soft limit warning at 20+ subtasks with helpful message
- Expansion state persists via DataStore
</success_criteria>

<output>
After completion, create `.planning/phases/03-structure-breakdown/03-02-SUMMARY.md`
</output>
