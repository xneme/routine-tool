---
phase: 03-structure-breakdown
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - app/src/main/java/com/routinetool/ui/components/SubtaskProgressIndicator.kt
  - app/src/main/java/com/routinetool/ui/components/TaskCard.kt
  - app/src/main/java/com/routinetool/ui/screens/tasklist/TaskListViewModel.kt
  - app/src/main/java/com/routinetool/ui/screens/tasklist/TaskListScreen.kt
  - app/src/main/java/com/routinetool/domain/model/TaskWithSubtasks.kt
autonomous: true

must_haves:
  truths:
    - "Collapsed task cards show subtask progress indicator"
    - "Progress shows checkbox row for <=6 subtasks, text count for >6"
    - "User can toggle subtask completion from expanded task card"
    - "Subtask completion triggers lighter haptic feedback than task completion"
    - "Completion timestamps are recorded for all subtask toggles"
  artifacts:
    - path: "app/src/main/java/com/routinetool/ui/components/SubtaskProgressIndicator.kt"
      provides: "Visual progress indicator for subtasks"
      contains: "SubtaskProgressIndicator"
    - path: "app/src/main/java/com/routinetool/domain/model/TaskWithSubtasks.kt"
      provides: "Domain model combining task with its subtasks"
      contains: "data class TaskWithSubtasks"
  key_links:
    - from: "TaskCard"
      to: "SubtaskProgressIndicator"
      via: "composable call with subtask counts"
      pattern: "SubtaskProgressIndicator"
    - from: "TaskListViewModel"
      to: "TaskRepository"
      via: "toggleSubtask method"
      pattern: "repository\\.toggleSubtask"
---

<objective>
Display subtask progress on task cards and enable subtask completion from the task list.

Purpose: Give users at-a-glance visibility of subtask progress and allow quick subtask completion without navigating to edit screen.
Output: SubtaskProgressIndicator composable, updated TaskCard with progress display and subtask checklist, TaskListViewModel with subtask toggle support.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-structure-breakdown/03-CONTEXT.md
@.planning/phases/03-structure-breakdown/03-RESEARCH.md
@.planning/phases/03-structure-breakdown/03-01-SUMMARY.md

@app/src/main/java/com/routinetool/ui/components/TaskCard.kt
@app/src/main/java/com/routinetool/ui/screens/tasklist/TaskListViewModel.kt
@app/src/main/java/com/routinetool/ui/screens/tasklist/TaskListScreen.kt
@app/src/main/java/com/routinetool/domain/model/Task.kt
@app/src/main/java/com/routinetool/domain/model/Subtask.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TaskWithSubtasks domain model and SubtaskProgressIndicator</name>
  <files>
    app/src/main/java/com/routinetool/domain/model/TaskWithSubtasks.kt
    app/src/main/java/com/routinetool/ui/components/SubtaskProgressIndicator.kt
  </files>
  <action>
Create TaskWithSubtasks domain model:
```kotlin
package com.routinetool.domain.model

data class TaskWithSubtasks(
    val task: Task,
    val subtasks: List<Subtask>
) {
    val completedSubtaskCount: Int get() = subtasks.count { it.isCompleted }
    val totalSubtaskCount: Int get() = subtasks.size
    val hasSubtasks: Boolean get() = subtasks.isNotEmpty()
}
```

Create SubtaskProgressIndicator composable:
- Takes completedCount: Int, totalCount: Int, modifier: Modifier
- If totalCount == 0, return (don't render anything)
- If totalCount <= 6: render row of small indicators (16.dp each, 4.dp spacing)
  - Completed: green checkmark Icon (Icons.Default.Check, tint Color(0xFF4CAF50))
  - Incomplete: empty Box with 1.dp border (MaterialTheme.colorScheme.onSurfaceVariant)
- If totalCount > 6: render Text "$completedCount/$totalCount" in bodySmall style

Follow the exact pattern from RESEARCH.md code example:
```kotlin
@Composable
fun SubtaskProgressIndicator(
    completedCount: Int,
    totalCount: Int,
    modifier: Modifier = Modifier
) {
    if (totalCount == 0) return

    if (totalCount <= 6) {
        Row(
            modifier = modifier,
            horizontalArrangement = Arrangement.spacedBy(4.dp)
        ) {
            repeat(totalCount) { index ->
                if (index < completedCount) {
                    Icon(
                        imageVector = Icons.Default.Check,
                        contentDescription = null,
                        tint = Color(0xFF4CAF50),
                        modifier = Modifier.size(16.dp)
                    )
                } else {
                    Box(
                        modifier = Modifier
                            .size(16.dp)
                            .border(1.dp, MaterialTheme.colorScheme.onSurfaceVariant, RoundedCornerShape(2.dp))
                    )
                }
            }
        }
    } else {
        Text(
            text = "$completedCount/$totalCount",
            style = MaterialTheme.typography.bodySmall,
            color = MaterialTheme.colorScheme.onSurfaceVariant,
            modifier = modifier
        )
    }
}
```

Note: Green checkmarks in indicator are same size as boxes (16.dp), unlike the larger checkmarks (32.dp) on full task completion per CONTEXT.md.
  </action>
  <verify>
Build compiles: `cd /home/xneme/Programming/routine-tool && ./gradlew assembleDebug 2>&1 | tail -20`
  </verify>
  <done>
TaskWithSubtasks domain model exists with computed properties. SubtaskProgressIndicator composable renders checkbox row for <=6, text count for >6.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update TaskListViewModel to observe tasks with subtasks</name>
  <files>
    app/src/main/java/com/routinetool/ui/screens/tasklist/TaskListViewModel.kt
    app/src/main/java/com/routinetool/data/repository/TaskRepository.kt
  </files>
  <action>
Add to TaskRepository:
- `observeActiveTasksWithSubtasks(): Flow<List<TaskWithSubtasks>>` - combines observeActiveTasks with subtasks for each task
  - Implementation: observeActiveTasks().flatMapLatest { tasks -> combine(tasks.map { task -> observeSubtasks(task.id).map { subtasks -> TaskWithSubtasks(task, subtasks) } }) { it.toList() } }
  - Handle empty list case gracefully (return flowOf(emptyList()))
- `observeRecentlyCompletedWithSubtasks(): Flow<List<TaskWithSubtasks>>` - same pattern for completed tasks
- `toggleSubtask(subtaskId: String)` - this should already exist from 03-01, but verify it records completedAt timestamp

Update TaskListViewModel:
- Change from observing `Task` to observing `TaskWithSubtasks`
- Update TaskListUiState to hold `List<TaskWithSubtasks>` instead of `List<Task>`
- Add `toggleSubtask(subtaskId: String)` function that calls repository.toggleSubtask
- Update section grouping logic to work with TaskWithSubtasks (access .task for properties)

The state already has overdue, active, and completed sections. Update each to use TaskWithSubtasks.
  </action>
  <verify>
Build compiles: `cd /home/xneme/Programming/routine-tool && ./gradlew assembleDebug 2>&1 | tail -20`
  </verify>
  <done>
TaskRepository has observeActiveTasksWithSubtasks and observeRecentlyCompletedWithSubtasks. TaskListViewModel uses TaskWithSubtasks for all task state. toggleSubtask function exists.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update TaskCard and TaskListScreen for subtask display</name>
  <files>
    app/src/main/java/com/routinetool/ui/components/TaskCard.kt
    app/src/main/java/com/routinetool/ui/screens/tasklist/TaskListScreen.kt
  </files>
  <action>
Update TaskCard to accept TaskWithSubtasks and subtask toggle callback:
- Change parameter from `task: Task` to `taskWithSubtasks: TaskWithSubtasks`
- Add parameter `onToggleSubtask: (String) -> Unit`
- Access task properties via `taskWithSubtasks.task`

Add SubtaskProgressIndicator to collapsed view:
- Position below the title, before deadline badge column
- Only show if `taskWithSubtasks.hasSubtasks`
```kotlin
if (taskWithSubtasks.hasSubtasks) {
    SubtaskProgressIndicator(
        completedCount = taskWithSubtasks.completedSubtaskCount,
        totalCount = taskWithSubtasks.totalSubtaskCount,
        modifier = Modifier.padding(top = 4.dp)
    )
}
```

Add subtask checklist to expanded view:
- Show after description, before deadline details
- Only if `taskWithSubtasks.subtasks.isNotEmpty()`
- Simple Column of subtask rows (no reordering here - that's edit screen only per CONTEXT.md)
- Each row: Checkbox + Text(title)
- On checkbox change, call `onToggleSubtask(subtask.id)`
- Add haptic feedback: HapticFeedbackConstants.VIRTUAL_KEY (lighter than CONFIRM used for task completion)
- Completed subtasks show green checkmark icon instead of checkbox (matching pattern)

```kotlin
if (taskWithSubtasks.subtasks.isNotEmpty()) {
    Column(
        modifier = Modifier.padding(vertical = 8.dp),
        verticalArrangement = Arrangement.spacedBy(4.dp)
    ) {
        Text(
            text = "Subtasks",
            style = MaterialTheme.typography.labelMedium,
            color = MaterialTheme.colorScheme.onSurfaceVariant
        )
        taskWithSubtasks.subtasks.forEach { subtask ->
            Row(
                verticalAlignment = Alignment.CenterVertically,
                modifier = Modifier.fillMaxWidth()
            ) {
                if (subtask.isCompleted) {
                    IconButton(onClick = {
                        view.performHapticFeedback(HapticFeedbackConstants.VIRTUAL_KEY)
                        onToggleSubtask(subtask.id)
                    }) {
                        Icon(
                            imageVector = Icons.Default.Check,
                            contentDescription = "Completed",
                            tint = Color(0xFF4CAF50),
                            modifier = Modifier.size(20.dp)
                        )
                    }
                } else {
                    Checkbox(
                        checked = false,
                        onCheckedChange = {
                            view.performHapticFeedback(HapticFeedbackConstants.VIRTUAL_KEY)
                            onToggleSubtask(subtask.id)
                        }
                    )
                }
                Text(
                    text = subtask.title,
                    style = MaterialTheme.typography.bodyMedium,
                    color = textColor
                )
            }
        }
    }
    Spacer(modifier = Modifier.height(8.dp))
}
```

Update TaskListScreen:
- Update TaskCard calls to pass TaskWithSubtasks instead of Task
- Pass viewModel::toggleSubtask as onToggleSubtask
- Update all places where task properties are accessed to use .task
  </action>
  <verify>
Build compiles: `cd /home/xneme/Programming/routine-tool && ./gradlew assembleDebug 2>&1 | tail -20`
Install and test:
1. Create task with subtasks
2. On task list, collapsed task shows progress indicator (checkbox row or count)
3. Expand task, see subtask checklist
4. Toggle subtask completion - verify lighter haptic than task completion
5. Progress indicator updates to reflect change
  </verify>
  <done>
TaskCard displays SubtaskProgressIndicator when collapsed. Expanded view shows subtask checklist with toggle capability. Subtask toggle uses lighter haptic (VIRTUAL_KEY). TaskListScreen passes TaskWithSubtasks to TaskCard.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Build succeeds: `./gradlew assembleDebug`
2. TaskWithSubtasks domain model exists
3. SubtaskProgressIndicator renders checkbox row for <=6, text for >6
4. TaskCard shows progress indicator when collapsed (if has subtasks)
5. Expanded TaskCard shows subtask checklist
6. Subtask toggle works with lighter haptic feedback
7. Progress indicator updates when subtasks are toggled
8. Completion timestamps are recorded (verify in debug/logs or DB inspection)
</verification>

<success_criteria>
- SubtaskProgressIndicator: checkbox row (16dp green check / bordered box) for <=6, text "X/Y" for >6
- TaskCard collapsed: shows progress indicator below title
- TaskCard expanded: shows subtask checklist with toggle capability
- Subtask completion haptic: VIRTUAL_KEY (lighter than CONFIRM for task completion)
- Completed subtasks show green checkmark, incomplete show checkbox
- All completion timestamps recorded in database
</success_criteria>

<output>
After completion, create `.planning/phases/03-structure-breakdown/03-03-SUMMARY.md`
</output>
